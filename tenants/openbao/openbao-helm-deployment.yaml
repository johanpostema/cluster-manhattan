apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: openbao-helm-deployment
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://openbao.github.io/openbao-helm
    chart: openbao
    targetRevision: 0.16.1
    # path: deploy/helm-chart/kubernetes-secret-generator
    #    targetRevision: master
    helm:
      releaseName: openbao-deployment
      values: |
        server:
          image:
            registry: "quay.io"
            repository: "openbao/openbao-hsm"
            tag: "2.3.1-amd64"
            pullPolicy: IfNotPresent
          dataStorage:
            enabled: true
            storageClass: zfs-localpv-default
            size: 10Gi
          standalone:
            config: |
              ui = true

              listener "tcp" {
                tls_disable = 1
                address = "[::]:8200"
                cluster_address = "[::]:8201"
                # Enable unauthenticated metrics access (necessary for Prometheus Operator)
                #telemetry {
                #  unauthenticated_metrics_access = "true"
                #}
              }
              storage "file" {
                path = "/openbao/data"
              }

              # custom hsm support voor auto-unseal
              # seal "pkcs11" {
              #   disabled = true
              #   lib = "/usr/lib64/pkcs11/pkcs11-spy.so"
              #   mechanism = 0x1087
              #   ##slot = "1645254618"
              #   ### token_label = "BaoUnsealToken"
              #   ##key_label = "bao-unseal-key-aes"
              #   ##key_id = "12345678901234561234567890123456"
              #   ##pin = "0987654321"
              #   token_label = "openbao"
              #   pin = "654321"
              #   key_label = "bao-root-key-rsa"
              #   rsa_oaep_hash = "sha1"
              # }
              #seal "pkcs11" {
              #  disabled = false
              #  lib = "/usr/lib64/softhsm/libsofthsm.so"
              #  token_label = "openbao"
              #  pin = "654321"
              #  key_label = "bao-root-key-rsa"
              #  rsa_oaep_hash = "sha1"
              #}

              # Example configuration for using auto-unseal, using Google Cloud KMS. The
              # GKMS keys must already exist, and the cluster must have a service account
              # that is authorized to access GCP KMS.
              #seal "gcpckms" {
              #   project     = "openbao-helm-dev"
              #   region      = "global"
              #   key_ring    = "openbao-helm-unseal-kr"
              #   crypto_key  = "openbao-helm-unseal-key"
              #}

              # Example configuration for enabling Prometheus metrics in your config.
              #telemetry {
              #  prometheus_retention_time = "30s"
              #  disable_hostname = true
              #}
  destination:
    server: "https://kubernetes.default.svc"
    namespace: openbao
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
